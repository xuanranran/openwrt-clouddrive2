name: "Compile The New Clouddrive2 version"

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Updates
        id: check
        run: |
          API_URL="https://api.github.com/repos/cloud-fs/cloud-fs.github.io/releases/latest"
          LATEST_TAG=$(curl -s "$API_URL" | grep '"tag_name":' | head -n 1 | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Failed to find latest release tag."
            exit 1
          fi
          
          NEW_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          echo "Latest Version: $NEW_VERSION"
          
          CURRENT_VERSION=$(grep '^PKG_VERSION:=' clouddrive2/Makefile | cut -d= -f2)
          echo "Current Version: $CURRENT_VERSION"
          
          if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
             echo "Update found!"
             echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
             echo "update_needed=true" >> $GITHUB_OUTPUT
          else
             echo "No update needed."
             echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate Hashes
        id: hashes
        if: steps.check.outputs.update_needed == 'true'
        run: |
          VER="${{ steps.check.outputs.new_version }}"
          BASE_URL="https://github.com/cloud-fs/cloud-fs.github.io/releases/download/v$VER"
          
          # Function to download and hash
          get_hash() {
            local arch=$1
            local filename="clouddrive-2-linux-${arch}-${VER}.tgz"
            echo "Downloading $filename..." >&2
            
            if ! curl -fsSL -o "$filename" "$BASE_URL/$filename"; then
              echo "Error: Failed to download $filename" >&2
              return 1
            fi
            
            local hash=$(sha256sum "$filename" | awk '{print $1}')
            rm "$filename"
            
            # Validate hash format (64 hex characters)
            if [[ ! "$hash" =~ ^[a-f0-9]{64}$ ]]; then
              echo "Error: Invalid hash format for $filename: $hash" >&2
              return 1
            fi
            
            echo "$hash"
          }
          
          HASH_X86_64=$(get_hash "x86_64")
          HASH_AARCH64=$(get_hash "aarch64")
          HASH_ARMV7=$(get_hash "armv7")
          
          # Output with proper formatting
          {
            echo "hash_x86_64=$HASH_X86_64"
            echo "hash_aarch64=$HASH_AARCH64"
            echo "hash_armv7=$HASH_ARMV7"
          } >> "$GITHUB_OUTPUT"

      - name: Update Makefile
        if: steps.check.outputs.update_needed == 'true'
        env:
          NEW_VER: ${{ steps.check.outputs.new_version }}
          HASH_X86_64: ${{ steps.hashes.outputs.hash_x86_64 }}
          HASH_AARCH64: ${{ steps.hashes.outputs.hash_aarch64 }}
          HASH_ARMV7: ${{ steps.hashes.outputs.hash_armv7 }}
        run: |
          MAKEFILE="clouddrive2/Makefile"
          
          echo "Updating Makefile..."
          echo "Version: $NEW_VER"
          echo "x86_64 hash: $HASH_X86_64"
          echo "aarch64 hash: $HASH_AARCH64"
          echo "armv7 hash: $HASH_ARMV7"
          
          # Update version
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$NEW_VER/" "$MAKEFILE"
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=1/" "$MAKEFILE"
          
          # Update hashes using awk for more precise matching
          awk -v x86="$HASH_X86_64" -v arm64="$HASH_AARCH64" -v arm7="$HASH_ARMV7" '
          BEGIN { in_x86=0; in_aarch64=0; in_arm=0; }
          /ifeq \(\$\(ARCH\),x86_64\)/ { in_x86=1; in_aarch64=0; in_arm=0; print; next; }
          /ifeq \(\$\(ARCH\),aarch64\)/ { in_x86=0; in_aarch64=1; in_arm=0; print; next; }
          /ifeq \(\$\(ARCH\),arm\)/ { in_x86=0; in_aarch64=0; in_arm=1; print; next; }
          /^endif/ { in_x86=0; in_aarch64=0; in_arm=0; print; next; }
          /^  PKG_HASH:=/ {
            if (in_x86) { print "  PKG_HASH:=" x86; next; }
            if (in_aarch64) { print "  PKG_HASH:=" arm64; next; }
            if (in_arm) { print "  PKG_HASH:=" arm7; next; }
          }
          { print }
          ' "$MAKEFILE" > "$MAKEFILE.tmp" && mv "$MAKEFILE.tmp" "$MAKEFILE"
          
          echo ""
          echo "=== Updated Makefile ==="
          cat "$MAKEFILE"

      - name: Commit and Push
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add clouddrive2/Makefile
          
          git commit -m "clouddrive2: update to ${{ steps.check.outputs.new_version }}"
          git push origin HEAD:${{ github.ref }}

      - name: Trigger Build
        if: steps.check.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run build.yml
