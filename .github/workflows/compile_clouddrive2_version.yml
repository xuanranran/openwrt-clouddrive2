name: "Compile The New Clouddrive2 version"

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Updates
        id: check
        run: |
          API_URL="https://api.github.com/repos/cloud-fs/cloud-fs.github.io/releases/latest"
          LATEST_TAG=$(curl -s "$API_URL" | grep '"tag_name":' | head -n 1 | sed -E 's/.*"([^"]+)".*/\1/')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Failed to find latest release tag."
            exit 1
          fi
          
          NEW_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
          echo "Latest Version: $NEW_VERSION"
          
          CURRENT_VERSION=$(grep '^PKG_VERSION:=' clouddrive2/Makefile | cut -d= -f2)
          echo "Current Version: $CURRENT_VERSION"
          
          if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
             echo "Update found!"
             echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
             echo "update_needed=true" >> $GITHUB_OUTPUT
          else
             echo "No update needed."
             echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate Hashes
        id: hashes
        if: steps.check.outputs.update_needed == 'true'
        run: |
          VER="${{ steps.check.outputs.new_version }}"
          BASE_URL="https://github.com/cloud-fs/cloud-fs.github.io/releases/download/v$VER"
          
          # Function to download and hash
          get_hash() {
            local arch=$1
            local filename="clouddrive-2-linux-${arch}-${VER}.tgz"
            echo "Downloading $filename..."
            curl -sL -o "$filename" "$BASE_URL/$filename"
            sha256sum "$filename" | awk '{print $1}'
            rm "$filename"
          }
          
          HASH_X86_64=$(get_hash "x86_64")
          HASH_AARCH64=$(get_hash "aarch64")
          HASH_ARMV7=$(get_hash "armv7")
          
          echo "hash_x86_64=$HASH_X86_64" >> $GITHUB_OUTPUT
          echo "hash_aarch64=$HASH_AARCH64" >> $GITHUB_OUTPUT
          echo "hash_armv7=$HASH_ARMV7" >> $GITHUB_OUTPUT

      - name: Update Makefile
        if: steps.check.outputs.update_needed == 'true'
        env:
          NEW_VER: ${{ steps.check.outputs.new_version }}
          HASH_X86_64: ${{ steps.hashes.outputs.hash_x86_64 }}
          HASH_AARCH64: ${{ steps.hashes.outputs.hash_aarch64 }}
          HASH_ARMV7: ${{ steps.hashes.outputs.hash_armv7 }}
        run: |
          python3 -c "
          import os
          import re

          makefile_path = 'clouddrive2/Makefile'
          new_ver = os.environ['NEW_VER']
          hash_x86 = os.environ['HASH_X86_64']
          hash_arm64 = os.environ['HASH_AARCH64']
          hash_arm7 = os.environ['HASH_ARMV7']

          with open(makefile_path, 'r') as f:
              content = f.read()

          # Update Version
          content = re.sub(r'^PKG_VERSION:=.*', f'PKG_VERSION:={new_ver}', content, flags=re.MULTILINE)
          content = re.sub(r'^PKG_RELEASE:=.*', 'PKG_RELEASE:=1', content, flags=re.MULTILINE)

          # Update Hashes - handling the ifeq blocks
          # x86_64
          content = re.sub(
              r'(ifeq \(\$\(ARCH\),x86_64\).*?PKG_HASH:=)[a-fA-F0-9]+',
              f'\\g<1>{hash_x86}',
              content,
              flags=re.DOTALL
          )
          
          # aarch64
          content = re.sub(
              r'(ifeq \(\$\(ARCH\),aarch64\).*?PKG_HASH:=)[a-fA-F0-9]+',
              f'\\g<1>{hash_arm64}',
              content,
              flags=re.DOTALL
          )
          
          # arm (armv7)
          content = re.sub(
              r'(ifeq \(\$\(ARCH\),arm\).*?PKG_HASH:=)[a-fA-F0-9]+',
              f'\\g<1>{hash_arm7}',
              content,
              flags=re.DOTALL
          )

          with open(makefile_path, 'w') as f:
              f.write(content)
          "
          
          echo "Makefile updated."
          cat clouddrive2/Makefile

      - name: Commit and Push
        if: steps.check.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add clouddrive2/Makefile
          
          git commit -m "clouddrive2: update to ${{ steps.check.outputs.new_version }}"
          git push origin HEAD:${{ github.ref }}

      - name: Trigger Build
        if: steps.check.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run build.yml
